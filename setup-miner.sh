#!/bin/sh
echo "                                                                                   ''''''"
echo " BBBBBBBBBBBBBBBBB     iiii                                OOOOOOOOO     lllllll  '::::'        ⣧     ⣿"
echo " B::::::::::::::::B   i::::i                             OO:::::::::OO   l:::::l  '::::'       ⢀⣿⣧   ⢰⡿⡇"
echo " B::::::BBBBBB:::::B   iiii                            OO:::::::::::::OO l:::::l  ':::''       ⢸⣿⡟⡆  ⣿⡇⢻"
echo " BB:::::B     B:::::B                                 O:::::::OOO:::::::Ol:::::l ':::'         ⢸⣿ ⣿ ⢰⣿⡇⢸"
echo "   B::::B     B:::::Biiiiiii    ggggggggg   ggggg     O::::::O   O::::::O l::::l ''''          ⢸⣿⡄⢸ ⢸⣿⡇⢸"
echo "   B::::B     B:::::Bi:::::i   g:::::::::ggg::::g     O:::::O     O:::::O l::::l               ⠘⣿⡇⢸⡄⠸⣿⡇⣿"
echo "   B::::BBBBBB:::::B  i::::i  g:::::::::::::::::g     O:::::O     O:::::O l::::l                ⢿⣿⢸⡅ ⣿⢠⡏"
echo "   B:::::::::::::BB   i::::i g::::::ggggg::::::gg     O:::::O     O:::::O l::::l                ⠈⣿⣿⣥⣾⣿⣿"
echo "   B::::BBBBBB:::::B  i::::i g:::::g     g:::::g      O:::::O     O:::::O l::::l                 ⣿⣿⣿⣿⣿⣿⣿⣆"
echo "   B::::B     B:::::B i::::i g:::::g     g:::::g      O:::::O     O:::::O l::::l                ⢸⣿⣿⣿⡿⡿⣿⣿⡿⡅"
echo "   B::::B     B:::::B i::::i g:::::g     g:::::g      O:::::O     O:::::O l::::l                ⢸⠉ ⠉⡙⢔⠛⣟⢋⠦⢵"
echo "   B::::B     B:::::B i::::i g::::::g    g:::::g      O::::::O   O::::::O l::::l                ⣾⣄  ⠁⣿⣯⡥⠃ ⢳"
echo " BB:::::BBBBBB::::::Bi::::::ig:::::::ggggg:::::g      O:::::::OOO:::::::Ol::::::l             ⢀⣴⣿⡇   ⠐⠠⠊⢀ ⢸"
echo " B:::::::::::::::::B i::::::i g::::::::::::::::g       OO:::::::::::::OO l::::::l          ⢀⣴⣿⣿⣿⡿     ⠈⠁  ⠘⣿⣄"
echo " B::::::::::::::::B  i::::::i  gg::::::::::::::g         OO:::::::::OO   l::::::l        ⣠⣿⣿⣿⣿⣿⡟           ⠈⣿⣷⡀"
echo " BBBBBBBBBBBBBBBBB   iiiiiiii    gggggggg::::::g           OOOOOOOOO     llllllll       ⣾⣿⣿⣿⣿⣿⠋             ⠈⣿⣿⣧"
echo "                                         g:::::g                                       ⡜⣭⠤⢍⣿⡟                ⢸⢛⢭⣗"
echo "                             gggggg      g:::::g                                       ⠁⠈  ⣀⠝               ⠄⠠  ⠰⡅"
echo "                            g:::::gg   gg:::::g                                        ⢀  ⡀⠡                 ⠁⠔⠠⡕"
echo "                            g::::::ggg:::::::g                                          ⣿⣷⣶⠒⠁                ⢰"
echo "                             gg:::::::::::::g                                           ⠘⣿⣿⡇                ⠰"
echo "        CCCCCCCCCCCCChhhhhhh   ggg::::::ggg                                              ⠈⢿⣿⣦             ⢠⠊⠉⢆"
echo "     CCC::::::::::::Ch:::::h     gggggg                                              ⢀⠤  ⢤⣤⣽⣿⣿⣦⣀⢀⡠⢤⡤⠄ ⠒ ⠁   ⢘⠔"
echo "   CC:::::::::::::::Ch:::::h                                                           ⡐⠈⠁⠈⠛⣛⠿⠟⠑⠈"
echo "  C:::::CCCCCCCC::::Ch:::::h                                                          ⠉⠑⠒ ⠁"
echo " C:::::C       CCCCCC h::::h hhhhh       uuuuuu    uuuuuunnnn  nnnnnnnn       ggggggggg   ggggguuuuuu    uuuuuu      ssssssssss"
echo "C:::::C               h::::hh:::::hhh    u::::u    u::::un:::nn::::::::nn    g:::::::::ggg::::gu::::u    u::::u    ss::::::::::s"
echo "C:::::C               h::::::::::::::hh  u::::u    u::::un::::::::::::::nn  g:::::::::::::::::gu::::u    u::::u  ss:::::::::::::s"
echo "C:::::C               h:::::::hhh::::::h u::::u    u::::unn:::::::::::::::ng::::::ggggg::::::ggu::::u    u::::u  s::::::ssss:::::s"
echo "C:::::C               h::::::h   h::::::hu::::u    u::::u  n:::::nnnn:::::ng:::::g     g:::::g u::::u    u::::u   s:::::s  ssssss"
echo "C:::::C               h:::::h     h:::::hu::::u    u::::u  n::::n    n::::ng:::::g     g:::::g u::::u    u::::u     s::::::s"
echo "C:::::C               h:::::h     h:::::hu::::u    u::::u  n::::n    n::::ng:::::g     g:::::g u::::u    u::::u        s::::::s"
echo " C:::::C       CCCCCC h:::::h     h:::::hu:::::uuuu:::::u  n::::n    n::::ng::::::g    g:::::g u:::::uuuu:::::u  ssssss   s:::::s"
echo "  C:::::CCCCCCCC::::C h:::::h     h:::::hu:::::::::::::::uun::::n    n::::ng:::::::ggggg:::::g u:::::::::::::::uus:::::ssss::::::s"
echo "   CC:::::::::::::::C h:::::h     h:::::h u:::::::::::::::un::::n    n::::n g::::::::::::::::g  u:::::::::::::::us::::::::::::::s"
echo "     CCC::::::::::::C h:::::h     h:::::h  uu::::::::uu:::un::::n    n::::n  gg::::::::::::::g   uu::::::::uu:::u s:::::::::::ss"
echo "        CCCCCCCCCCCCC hhhhhhh     hhhhhhh    uuuuuuuu  uuuunnnnnn    nnnnnn    gggggggg::::::g     uuuuuuuu  uuuu  sssssssssss"
echo "                                                                                       g:::::g"
echo "                                                                           gggggg      g:::::g"
echo "                                                                           g:::::gg   gg:::::g"
echo "                                                                            g::::::ggg:::::::g"
echo "                                                                             gg:::::::::::::g"
echo "                                                                               ggg::::::ggg"
echo "                                                                                  gggggg"
echo ""
echo ""
sleep 1


export $(grep -E '^ID=' /etc/os-release)
export $(grep -E '^VERSION_ID=' /etc/os-release | sed 's/"//g')

if [ "$?" != "0" ] || \
   [ "$ID" != "ubuntu" ] || \
   [ "$VERSION_ID" != "18.04" ] ; then

  echo "You are not on a supported OS."
  echo "Please use Ubuntu 18.04."
  echo "Alternatively, perform a manual installation."
  echo ""
  echo "Setup aborted."
  exit 1
fi

set -o errexit

echo "\nSetting up kadena-miner user..."
mkdir /home/kadena-miner
cd /home/kadena-miner
useradd kadena-miner

echo "\nConfiguring miner..."
EXAMPLE_NODE="--node fr1.chainweb.com:443"

while [ -z "$NODES" ]; do
  echo -n "Enter the nodes you wish to connect to [example = $EXAMPLE_NODE]: "
  read NODES
done

if [ "$NODES" != *"--node"* ]; then
  NODES="--node $NODES"
fi

while [ -z "$ACCOUNT_NAME" ]; do
  echo -n "Enter your account name: "
  read ACCOUNT_NAME
done

while [ -z "$ACCOUNT_KEY" ]; do
  echo -n "Enter your account key: "
  read ACCOUNT_KEY
done

echo "\nWriting miner configuration to /home/kadena-miner/env..."

cat <<EOF > /home/kadena-miner/env
NODES='$NODES'
PUBLIC_KEY='$ACCOUNT_KEY'
ACCOUNT_NAME='$ACCOUNT_NAME'
CHAINWEB_MINER_EXEC=/home/kadena-miner/chainweb-miner
EOF

echo "Miner configuration: \n"
cat /home/kadena-miner/env

echo "\nInstalling base dependencies..."
apt-get update
apt install -y git ocl-icd-* opencl-headers clinfo
apt install -y g++
apt install -y librocksdb5.8 ubuntu-drivers-common
apt install -y cmake

FILE_NAME="chainweb-miner.8.6.5.ubuntu-$VERSION_ID.tar.gz"

echo "\nInstalling chanweb-miner..."
wget "https://github.com/kadena-io/chainweb-miner/releases/download/v1.0.1/$FILE_NAME"
tar -xzf $FILE_NAME

echo "\nInstalling OpenCL..."
ubuntu-drivers autoinstall --gpgpu

echo "\nCloning the BigOlChungus..."
git clone https://github.com/kadena-community/bigolchungus.git --single-branch --branch master /home/kadena-miner/BigOlChungus
cd /home/kadena-miner/BigOlChungus
cmake .
make

echo "\nSetting up the systemd service..."
cp '/home/kadena-miner/BigOlChungus/resources/kadena-miner@.service' '/etc/systemd/system/kadena-miner@.service'


echo "\nSetting up kadena-miner permissions..."
chown -R kadena-miner /home/kadena-miner/

echo "\n\nSetup complete. Rebooting to finish OpenCL installation in 10 seconds. Ctrl+C to cancel reboot."
sleep 10
reboot
